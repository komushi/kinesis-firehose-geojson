### 1. Create an ElasticSearch Domain and set proper access policy
https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/es-gsg-create-domain.html

#### Remember to change th ElasticSearch endpoint with your own endpoint

### 2. Map the GeoJson to the index before creating a firehose delivery stream 
```
curl -X PUT "https://search-estokyo-hcioeeiwecw6qhwzd45z2uv6au.ap-northeast-1.es.amazonaws.com/index_geojson" -H 'Content-Type: application/json' -d'
{
  "mappings": {
    "type_geojson": {
      "properties": {
        "geometry": {
          "type": "geo_shape",
          "tree": "quadtree",
          "precision": "1m"
        }
      }
    }
  }
}
'
```

### 3. Create a Firehose delivery stream called 'geojson'
https://docs.aws.amazon.com/firehose/latest/dev/basic-create.html
https://docs.aws.amazon.com/firehose/latest/dev/create-destination.html#create-destination-elasticsearch

* Index: index_geojson
* Type: type_geojson

### 4. Send GeoJson through Firehose

```
aws firehose put-record-batch --delivery-stream-name geojson --records file://tokyo_23_brief_es01.json

aws firehose put-record-batch --delivery-stream-name geojson --records file://tokyo_23_brief_es02.json

aws firehose put-record-batch --delivery-stream-name geojson --records file://tokyo_23_brief_es03.json

aws firehose put-record-batch --delivery-stream-name geojson --records file://tokyo_23_brief_es04.json

aws firehose put-record-batch --delivery-stream-name geojson --records file://tokyo_23_brief_es05.json
```

### 5. Query polygon with point argument

#### Query Request
```
curl -X GET "https://search-estokyo-hcioeeiwecw6qhwzd45z2uv6au.ap-northeast-1.es.amazonaws.com/index_geojson/_search" -H 'Content-Type: application/json' -d'
{
    "query":{
        "bool": {
            "must": {
                "match_all": {}
            },
            "filter": {
                "geo_shape": {
                    "geometry": {
                        "shape": {
                            "type": "point",
                            "coordinates" : [ 139.7034614, 35.7032652 ]
                        },
                        "relation": "CONTAINS"
                    }
                }
            }
        }
    }
}
'

```

#### Reponse
```
{
  "took": 4,
  "timed_out": false,
  "_shards": {
    "total": 5,
    "successful": 5,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 1,
    "max_score": 1.0,
    "hits": [
      {
        "_index": "index_geojson",
        "_type": "type_geojson",
        "_id": "49583848715254368176618678705391651575974906004749942786.0",
        "_score": 1.0,
        "_source": {
          "properties": {
            "district": "新宿区",
            "district_code": "104",
            "block": "大久保",
            "block_code": "1040840"
          },
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  139.7056169447295,
                  35.69808160722822
                ],
                [
                  139.70558075087615,
                  35.6980820961306
                ],
                [
                  139.705311693931,
                  35.69811951978534
                ],
                [
                  139.70518252853037,
                  35.6981375033848
                ],
                [
                  139.70507904231846,
                  35.69815191145267
                ],
                [
                  139.7050514469234,
                  35.69815346665235
                ],
                [
                  139.70461433937703,
                  35.69821204664808
                ],
                [
                  139.7043621910251,
                  35.69820846703212
                ],
                [
                  139.70416183753747,
                  35.69819994260421
                ],
                [
                  139.704049316638,
                  35.69819513926425
                ],
                [
                  139.70380965394108,
                  35.6981716085169
                ],
                [
                  139.70350478950036,
                  35.69814353444837
                ],
                [
                  139.70329638461305,
                  35.69812246555254
                ],
                [
                  139.7026145782988,
                  35.69805581517362
                ],
                [
                  139.70199043623435,
                  35.69801073757507
                ],
                [
                  139.70203568234203,
                  35.69830087780951
                ],
                [
                  139.70210576546532,
                  35.69881874455045
                ],
                [
                  139.7021855373888,
                  35.699580235657415
                ],
                [
                  139.70219406597394,
                  35.69961126442858
                ],
                [
                  139.70224568846007,
                  35.699995385689974
                ],
                [
                  139.70225507654607,
                  35.70008130744792
                ],
                [
                  139.7022873233432,
                  35.70037664412751
                ],
                [
                  139.70230717842475,
                  35.700529439412946
                ],
                [
                  139.702327799643,
                  35.70068815116527
                ],
                [
                  139.70235914400686,
                  35.7009294735974
                ],
                [
                  139.70236095557388,
                  35.70094342054123
                ],
                [
                  139.70240333890035,
                  35.70126964704395
                ],
                [
                  139.702298559009,
                  35.701293229833766
                ],
                [
                  139.70234729174393,
                  35.701841950928184
                ],
                [
                  139.70236887276644,
                  35.70208302833649
                ],
                [
                  139.70237870397546,
                  35.70219284744733
                ],
                [
                  139.70240538695327,
                  35.70249091087915
                ],
                [
                  139.70240630181112,
                  35.70250113602189
                ],
                [
                  139.70240917453762,
                  35.702530480277844
                ],
                [
                  139.70241048318536,
                  35.70254384979897
                ],
                [
                  139.7025382866465,
                  35.7038537805957
                ],
                [
                  139.70255257377704,
                  35.70400026751715
                ],
                [
                  139.70258648647828,
                  35.704347645266154
                ],
                [
                  139.70255898544457,
                  35.704349622716
                ],
                [
                  139.70154191837025,
                  35.704422628515744
                ],
                [
                  139.7015355722299,
                  35.70442307945715
                ],
                [
                  139.70149847619598,
                  35.70411115395058
                ],
                [
                  139.7013772025186,
                  35.70410841609012
                ],
                [
                  139.70116701502246,
                  35.70412519052308
                ],
                [
                  139.70055709978007,
                  35.70417391825657
                ],
                [
                  139.70067279160392,
                  35.70451705653534
                ],
                [
                  139.70073985945433,
                  35.7047085635558
                ],
                [
                  139.70080384101172,
                  35.70489344933525
                ],
                [
                  139.70088979969685,
                  35.70513391832844
                ],
                [
                  139.7009569831127,
                  35.70532768055119
                ],
                [
                  139.7010029506613,
                  35.705481595422825
                ],
                [
                  139.7010484911744,
                  35.70562653223884
                ],
                [
                  139.70106319590684,
                  35.70568795369375
                ],
                [
                  139.70107953051846,
                  35.70575617230629
                ],
                [
                  139.70111070693395,
                  35.70583563909929
                ],
                [
                  139.70112664513536,
                  35.70587625305709
                ],
                [
                  139.7011865718683,
                  35.706034233908085
                ],
                [
                  139.70122669042289,
                  35.706148919491824
                ],
                [
                  139.70125045095594,
                  35.70621686500628
                ],
                [
                  139.7013205842825,
                  35.70641619254767
                ],
                [
                  139.70133663161278,
                  35.70646180554849
                ],
                [
                  139.7014300398022,
                  35.70674259840633
                ],
                [
                  139.701527313852,
                  35.706989452834804
                ],
                [
                  139.7015667973754,
                  35.707123291538096
                ],
                [
                  139.70183711053153,
                  35.7079317672407
                ],
                [
                  139.70184297287818,
                  35.70794614315792
                ],
                [
                  139.70186318730603,
                  35.70799571851577
                ],
                [
                  139.7019065654363,
                  35.70812610372589
                ],
                [
                  139.701991630756,
                  35.708381789469016
                ],
                [
                  139.7021372330845,
                  35.708782561266
                ],
                [
                  139.70231393436055,
                  35.709345735325144
                ],
                [
                  139.70235567176402,
                  35.70945581089158
                ],
                [
                  139.702400591611,
                  35.70957432124285
                ],
                [
                  139.70250259499096,
                  35.709552251532
                ],
                [
                  139.70276996708142,
                  35.70949439252053
                ],
                [
                  139.70310752535727,
                  35.70942134796764
                ],
                [
                  139.70336576162637,
                  35.70935923502389
                ],
                [
                  139.7034357463039,
                  35.709342392966796
                ],
                [
                  139.70358703113072,
                  35.709307409454894
                ],
                [
                  139.70380614342574,
                  35.70925674120609
                ],
                [
                  139.7043757146982,
                  35.70912501797573
                ],
                [
                  139.7047563207859,
                  35.70903903891084
                ],
                [
                  139.7049416839294,
                  35.70899716224161
                ],
                [
                  139.7050850363046,
                  35.70897911126686
                ],
                [
                  139.7054545696342,
                  35.70893255275869
                ],
                [
                  139.7056905851479,
                  35.708915180917145
                ],
                [
                  139.70587121642168,
                  35.70889620139566
                ],
                [
                  139.70624350921594,
                  35.70880316645356
                ],
                [
                  139.70625293898084,
                  35.708800662517795
                ],
                [
                  139.70630671482806,
                  35.70878638586087
                ],
                [
                  139.70653918495137,
                  35.70872466249528
                ],
                [
                  139.70679429403657,
                  35.708659860908384
                ],
                [
                  139.70683969057637,
                  35.70864832795622
                ],
                [
                  139.70721750131267,
                  35.70855946818834
                ],
                [
                  139.70742704050795,
                  35.70852873852814
                ],
                [
                  139.70752689095136,
                  35.70852963529876
                ],
                [
                  139.70778288393143,
                  35.70853814211688
                ],
                [
                  139.7081906941889,
                  35.7085605377845
                ],
                [
                  139.70820595521775,
                  35.70855338873249
                ],
                [
                  139.70840316241177,
                  35.70853498509128
                ],
                [
                  139.70845026090905,
                  35.70854806138699
                ],
                [
                  139.70902809089867,
                  35.7085099824552
                ],
                [
                  139.7090538555753,
                  35.70850895268128
                ],
                [
                  139.70899403113248,
                  35.70807127224351
                ],
                [
                  139.70895980771823,
                  35.70782093304327
                ],
                [
                  139.70889015046347,
                  35.7072468238429
                ],
                [
                  139.70886357191063,
                  35.70702776887087
                ],
                [
                  139.7088610513276,
                  35.707006997068454
                ],
                [
                  139.7088571700762,
                  35.70697500730319
                ],
                [
                  139.70885196522906,
                  35.70697767896431
                ],
                [
                  139.708832885887,
                  35.70682287725149
                ],
                [
                  139.70880685947705,
                  35.706611396974594
                ],
                [
                  139.70880529340315,
                  35.70659866991715
                ],
                [
                  139.70876885857285,
                  35.70633494849536
                ],
                [
                  139.7086746442815,
                  35.70569608045924
                ],
                [
                  139.70862359063977,
                  35.70535368639625
                ],
                [
                  139.70856695658622,
                  35.70484590626941
                ],
                [
                  139.70855873677158,
                  35.70477995945216
                ],
                [
                  139.7085252922459,
                  35.70451165485585
                ],
                [
                  139.70863528199445,
                  35.704504939262385
                ],
                [
                  139.70881111124328,
                  35.704492797011625
                ],
                [
                  139.70910193116393,
                  35.704269587554215
                ],
                [
                  139.70909912772697,
                  35.70423310830512
                ],
                [
                  139.70909138325695,
                  35.70413257670958
                ],
                [
                  139.70907938686798,
                  35.703976868295
                ],
                [
                  139.70907501788068,
                  35.703920211318476
                ],
                [
                  139.7090711247516,
                  35.703869540784254
                ],
                [
                  139.70905161653343,
                  35.70369361424248
                ],
                [
                  139.70904037157302,
                  35.70359362073945
                ],
                [
                  139.70902320443477,
                  35.70344095717854
                ],
                [
                  139.70901928679888,
                  35.703406130773296
                ],
                [
                  139.70900376185415,
                  35.7032299613561
                ],
                [
                  139.70898486111602,
                  35.70309368106494
                ],
                [
                  139.70897686422674,
                  35.702961602470054
                ],
                [
                  139.70893446238935,
                  35.70258027600361
                ],
                [
                  139.70892513873918,
                  35.702496431538755
                ],
                [
                  139.708922073573,
                  35.702482733067946
                ],
                [
                  139.70890684664417,
                  35.70225300958723
                ],
                [
                  139.7089056913152,
                  35.70223698847587
                ],
                [
                  139.70890487128423,
                  35.702225650289684
                ],
                [
                  139.70889038430272,
                  35.70202687765068
                ],
                [
                  139.7088845098395,
                  35.70194645380778
                ],
                [
                  139.70887594283488,
                  35.70185790950771
                ],
                [
                  139.70886499832233,
                  35.70174482314952
                ],
                [
                  139.7088475512321,
                  35.70155450942292
                ],
                [
                  139.70883894724813,
                  35.7014606560508
                ],
                [
                  139.70881036709858,
                  35.701163569790715
                ],
                [
                  139.70880929592894,
                  35.70115243685295
                ],
                [
                  139.7088029904065,
                  35.70108496963916
                ],
                [
                  139.70880084901813,
                  35.70106209444302
                ],
                [
                  139.70878890398743,
                  35.70093450500456
                ],
                [
                  139.70877696600343,
                  35.70082871773253
                ],
                [
                  139.7087093670316,
                  35.70083056045881
                ],
                [
                  139.70869251426473,
                  35.70083190136382
                ],
                [
                  139.70845492280844,
                  35.70084469693752
                ],
                [
                  139.70801799259812,
                  35.700868227230714
                ],
                [
                  139.70791688436182,
                  35.70087367162077
                ],
                [
                  139.70793825540204,
                  35.70084281590368
                ],
                [
                  139.7077811550504,
                  35.7000849089616
                ],
                [
                  139.70774778456007,
                  35.699860518646766
                ],
                [
                  139.70771113465892,
                  35.69962830917705
                ],
                [
                  139.70765500024285,
                  35.69937001644394
                ],
                [
                  139.70753261847284,
                  35.698806885645794
                ],
                [
                  139.7074942227777,
                  35.698630211734915
                ],
                [
                  139.70745378746543,
                  35.698431692946635
                ],
                [
                  139.70735786415995,
                  35.69796076926137
                ],
                [
                  139.7073365091544,
                  35.697855930112674
                ],
                [
                  139.70701342625972,
                  35.697912243188696
                ],
                [
                  139.70684787657981,
                  35.69792164638839
                ],
                [
                  139.70664502778777,
                  35.69794850828277
                ],
                [
                  139.70646705973374,
                  35.69797207633077
                ],
                [
                  139.7064331845186,
                  35.69797656187207
                ],
                [
                  139.7061770446665,
                  35.69801047765333
                ],
                [
                  139.70592741575928,
                  35.69803155084863
                ],
                [
                  139.7057661103788,
                  35.69806085012613
                ],
                [
                  139.7056169447295,
                  35.69808160722822
                ]
              ]
            ]
          }
        }
      }
    ]
  }
}
```

-------------------------------------------
## Below are just some ElasticSearch API samples

### Find Geo JSON documents by query
```
curl -X GET "https://search-estokyo-hcioeeiwecw6qhwzd45z2uv6au.ap-northeast-1.es.amazonaws.com/index_geojson/_search" -H 'Content-Type: application/json' -d'
{
  "query": { 
    "exists": {
      "field": "geometry"
    }
  }
}
'
```


### Remove Geo JSON documents by query
```
curl -X POST "https://search-estokyo-hcioeeiwecw6qhwzd45z2uv6au.ap-northeast-1.es.amazonaws.com/index_geojson/_delete_by_query" -H 'Content-Type: application/json' -d'
{
  "query": {
    "exists" : { "field" : "geometry" }
  }
}
'
```

### Import 1 doc via Firehose
```
aws firehose put-record --delivery-stream-name geojson --record file://oneline.json
```

### Remove Index
```
curl -X DELETE "https://search-estokyo-hcioeeiwecw6qhwzd45z2uv6au.ap-northeast-1.es.amazonaws.com/index_geojson"
```
